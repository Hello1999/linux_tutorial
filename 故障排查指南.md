# Linux故障排查指南

## 系统无法启动

### 问题：GRUB错误
**症状**：启动时显示 "grub rescue>" 或 "error: file not found"

**原因**：
- 硬盘分区表损坏
- GRUB配置文件损坏
- 双系统时Windows更新覆盖GRUB

**解决方案**：
```bash
# 从Live CD启动后
sudo mount /dev/sda1 /mnt              # 挂载根分区
sudo mount /dev/sda2 /mnt/boot         # 如果boot是独立分区
sudo mount --bind /dev /mnt/dev
sudo mount --bind /proc /mnt/proc
sudo mount --bind /sys /mnt/sys
sudo chroot /mnt

# 重新安装GRUB
grub-install /dev/sda
update-grub

# 退出并重启
exit
sudo reboot
```

### 问题：内核Panic
**症状**：启动时卡住，显示 "Kernel panic"

**原因**：
- 内核损坏
- 硬件故障
- 驱动问题

**解决方案**：
1. 从GRUB菜单选择旧版内核启动
2. 进入系统后卸载有问题的内核或驱动
3. 更新系统

---

## 系统性能问题

### 问题：系统卡顿、响应慢

**诊断步骤**：

**1. 检查CPU使用率**
```bash
top
htop

# 查看CPU占用最高的进程
ps aux --sort=-%cpu | head -10
```

**2. 检查内存使用**
```bash
free -h
vmstat 1 10

# 查看内存占用最高的进程
ps aux --sort=-%mem | head -10

# 检查是否发生OOM (Out of Memory)
dmesg | grep -i "out of memory"
```

**3. 检查磁盘I/O**
```bash
iostat -xz 1
iotop

# 查看磁盘占用
df -h
du -sh /* | sort -hr
```

**4. 检查系统负载**
```bash
uptime
w

# 负载说明：
# - 单核CPU：负载1.0表示满载
# - 四核CPU：负载4.0表示满载
# - 负载 > CPU核数 表示有进程等待
```

**常见解决方案**：

**CPU占用高**：
```bash
# 查找并杀死占用CPU的进程
kill -15 PID       # 优雅终止
kill -9 PID        # 强制终止
```

**内存不足**：
```bash
# 清理缓存
sync; echo 3 > /proc/sys/vm/drop_caches

# 增加swap空间
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 永久生效
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

**磁盘I/O高**：
```bash
# 查找占用磁盘的进程
iotop -o

# 检查磁盘健康
sudo smartctl -a /dev/sda

# 清理日志
sudo journalctl --vacuum-time=7d
sudo apt clean
```

---

## 网络问题

### 问题：无法连接网络

**诊断步骤**：

**1. 检查网络接口**
```bash
ip addr show
ip link show

# 启用网卡
sudo ip link set eth0 up
```

**2. 检查网络配置**
```bash
cat /etc/netplan/*.yaml     # Ubuntu 18.04+
cat /etc/network/interfaces  # Debian/旧Ubuntu

# 重启网络服务
sudo systemctl restart networking
sudo netplan apply          # Ubuntu 18.04+
```

**3. 检查DNS**
```bash
cat /etc/resolv.conf

# 测试DNS解析
nslookup google.com
dig google.com

# 临时修改DNS
echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf
```

**4. 检查路由**
```bash
ip route show
traceroute google.com

# 添加默认路由
sudo ip route add default via 192.168.1.1
```

**5. 测试连通性**
```bash
# 测试本地回环
ping 127.0.0.1

# 测试网关
ping 192.168.1.1

# 测试外网IP
ping 8.8.8.8

# 测试域名
ping google.com
```

### 问题：SSH连接失败

**诊断**：
```bash
# 检查SSH服务状态
sudo systemctl status sshd

# 检查端口监听
sudo netstat -tuln | grep :22
sudo ss -tuln | grep :22

# 查看SSH日志
sudo tail -f /var/log/auth.log    # Debian/Ubuntu
sudo tail -f /var/log/secure       # RHEL/CentOS

# 测试SSH连接（详细模式）
ssh -vvv user@host
```

**解决方案**：
```bash
# 重启SSH服务
sudo systemctl restart sshd

# 检查防火墙
sudo ufw status
sudo ufw allow 22

# 检查SSH配置
sudo vim /etc/ssh/sshd_config
# 确保：
# PermitRootLogin no
# PasswordAuthentication yes/no
# Port 22

# 重新加载配置
sudo systemctl reload sshd
```

---

## 磁盘问题

### 问题：磁盘空间满

**查找大文件和目录**：
```bash
# 查看磁盘使用
df -h

# 查找大目录
du -sh /* | sort -hr | head -10
du -ah /var | sort -hr | head -20

# 查找大文件（>100MB）
find / -type f -size +100M -exec ls -lh {} \; 2>/dev/null

# 查找最近修改的大文件
find / -type f -size +50M -mtime -7 2>/dev/null
```

**清理方案**：
```bash
# 清理APT缓存
sudo apt clean
sudo apt autoclean
sudo apt autoremove

# 清理旧内核
dpkg --list | grep linux-image
sudo apt remove linux-image-x.x.x-x-generic

# 清理日志
sudo journalctl --vacuum-time=7d
sudo rm -rf /var/log/*.gz
sudo rm -rf /var/log/*.old

# 清理临时文件
sudo rm -rf /tmp/*
sudo rm -rf /var/tmp/*

# 清理缩略图缓存
rm -rf ~/.cache/thumbnails/*

# 清理包缓存
sudo rm -rf /var/cache/apt/archives/*
```

### 问题：磁盘只读

**症状**：无法写入文件，提示 "Read-only file system"

**原因**：文件系统错误导致内核将分区挂载为只读

**解决方案**：
```bash
# 查看挂载状态
mount | grep "ro,"

# 重新挂载为读写
sudo mount -o remount,rw /

# 如果失败，需要修复文件系统
# 1. 进入单用户模式或Live CD
# 2. 卸载分区
sudo umount /dev/sda1

# 3. 检查并修复文件系统
sudo fsck -y /dev/sda1
sudo e2fsck -f /dev/sda1

# 4. 重新挂载
sudo mount /dev/sda1 /mnt
```

---

## 权限问题

### 问题：Permission Denied

**诊断**：
```bash
# 查看文件权限
ls -l file.txt

# 查看目录权限
ls -ld /path/to/directory

# 查看所有者
stat file.txt
```

**解决方案**：
```bash
# 修改权限
chmod 644 file.txt        # 文件
chmod 755 directory       # 目录
chmod +x script.sh        # 添加执行权限

# 修改所有者
sudo chown user:group file.txt
sudo chown -R user:group directory/

# 当前用户添加到组
sudo usermod -aG groupname $USER
# 需要重新登录生效
```

---

## 软件包问题

### 问题：apt/yum安装失败

**APT (Debian/Ubuntu)**：
```bash
# 修复损坏的包
sudo apt --fix-broken install
sudo dpkg --configure -a

# 清理缓存
sudo apt clean
sudo apt update

# 解决依赖问题
sudo apt install -f

# 强制重新配置包
sudo dpkg-reconfigure package-name

# 完全删除包和配置
sudo apt purge package-name
```

**锁文件问题**：
```bash
# 删除锁文件
sudo rm /var/lib/apt/lists/lock
sudo rm /var/cache/apt/archives/lock
sudo rm /var/lib/dpkg/lock*

# 重新配置dpkg
sudo dpkg --configure -a
```

---

## 服务问题

### 问题：服务无法启动

**诊断**：
```bash
# 查看服务状态
sudo systemctl status service_name

# 查看详细日志
sudo journalctl -u service_name -n 50 --no-pager

# 实时查看日志
sudo journalctl -u service_name -f

# 检查配置文件语法
# Nginx
sudo nginx -t

# Apache
sudo apache2ctl configtest

# SSH
sudo sshd -t
```

**解决方案**：
```bash
# 重启服务
sudo systemctl restart service_name

# 重新加载配置
sudo systemctl reload service_name

# 启用开机启动
sudo systemctl enable service_name

# 查看失败的服务
systemctl --failed

# 重置失败状态
sudo systemctl reset-failed service_name
```

---

## 用户和登录问题

### 问题：忘记root密码

**解决方案（Ubuntu/Debian）**：

1. 重启进入GRUB菜单
2. 按 `e` 编辑启动项
3. 找到以 `linux` 开头的行
4. 在行尾添加 `init=/bin/bash`
5. 按 `Ctrl+X` 或 `F10` 启动
6. 执行：
```bash
mount -o remount,rw /
passwd root
# 输入新密码
exec /sbin/init
```

### 问题：用户无法登录

**检查**：
```bash
# 查看用户信息
id username
grep username /etc/passwd

# 检查是否被锁定
sudo passwd -S username

# 解锁用户
sudo passwd -u username
sudo usermod -U username

# 检查Shell是否有效
grep username /etc/passwd
# 如果shell是/usr/sbin/nologin，需要修改
sudo usermod -s /bin/bash username

# 检查主目录权限
ls -ld /home/username
sudo chown -R username:username /home/username
```

---

## 常用排查工具

### 系统监控
```bash
top         # 进程监控
htop        # 更好的top
atop        # 高级监控
glances     # 全面监控
```

### 网络工具
```bash
ping        # 测试连通性
traceroute  # 路由跟踪
netstat     # 网络统计
ss          # socket统计
tcpdump     # 抓包
wireshark   # 图形化抓包分析
nmap        # 端口扫描
```

### 日志查看
```bash
dmesg                  # 内核日志
journalctl             # systemd日志
tail -f /var/log/syslog  # 系统日志
cat /var/log/auth.log    # 认证日志
```

### 磁盘工具
```bash
df          # 磁盘空间
du          # 目录大小
iostat      # I/O统计
iotop       # I/O监控
smartctl    # 硬盘健康
```

### 进程工具
```bash
ps          # 进程列表
pgrep       # 查找进程
lsof        # 打开文件列表
strace      # 系统调用跟踪
```

---

## 日志文件位置

```bash
/var/log/syslog         # 系统日志（Debian/Ubuntu）
/var/log/messages       # 系统日志（RHEL/CentOS）
/var/log/auth.log       # 认证日志
/var/log/kern.log       # 内核日志
/var/log/boot.log       # 启动日志
/var/log/dmesg          # 启动消息
/var/log/nginx/         # Nginx日志
/var/log/apache2/       # Apache日志
/var/log/mysql/         # MySQL日志
~/.xsession-errors      # X会话错误
```

---

## 故障排查流程

1. **定义问题** - 准确描述发生了什么
2. **收集信息** - 查看日志、错误消息
3. **隔离原因** - 缩小问题范围
4. **尝试解决** - 应用解决方案
5. **验证结果** - 确认问题已解决
6. **记录文档** - 记录问题和解决方案

### 提问模板

如果需要寻求帮助，提供以下信息：
- 发行版和版本：`lsb_release -a`
- 内核版本：`uname -r`
- 硬件信息：`lscpu`, `free -h`
- 问题描述：发生了什么？预期结果？
- 错误消息：完整的错误输出
- 已尝试的解决方案
- 相关日志：`journalctl -xe`

---

**记住：不要害怕错误，每个错误都是学习的机会！**
