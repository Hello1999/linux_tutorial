# Linux最佳实践

## 安全最佳实践

### 1. 用户和权限管理

**不要使用root日常操作**
```bash
# 不好
su -    # 切换到root

# 好
sudo command    # 只在需要时提权
```

**使用强密码**
```bash
# 生成随机密码
openssl rand -base64 32

# 设置密码策略
sudo vim /etc/security/pwquality.conf
# minlen = 12
# minclass = 3
# maxrepeat = 2
```

**定期审查用户账户**
```bash
# 列出所有用户
cut -d: -f1 /etc/passwd

# 查看最近登录
lastlog

# 删除不用的账户
sudo userdel -r unused_user
```

**使用sudo而不是直接登录root**
```bash
# 禁用root SSH登录
sudo vim /etc/ssh/sshd_config
# PermitRootLogin no

sudo systemctl reload sshd
```

### 2. SSH安全

**使用SSH密钥认证**
```bash
# 生成密钥对
ssh-keygen -t ed25519 -C "your_email@example.com"

# 复制公钥到服务器
ssh-copy-id user@server

# 禁用密码登录
sudo vim /etc/ssh/sshd_config
# PasswordAuthentication no
# PubkeyAuthentication yes
```

**更改SSH端口**
```bash
sudo vim /etc/ssh/sshd_config
# Port 2222  # 改为非标准端口

# 更新防火墙
sudo ufw allow 2222/tcp
sudo ufw delete allow 22/tcp

sudo systemctl reload sshd
```

**限制SSH访问**
```bash
# 只允许特定用户
sudo vim /etc/ssh/sshd_config
# AllowUsers user1 user2

# 只允许特定IP
# AllowUsers user1@192.168.1.100
```

**使用fail2ban防止暴力破解**
```bash
sudo apt install fail2ban
sudo systemctl enable fail2ban
sudo systemctl start fail2ban

# 配置
sudo vim /etc/fail2ban/jail.local
# [sshd]
# enabled = true
# maxretry = 3
# bantime = 3600
```

### 3. 防火墙

**启用UFW（Uncomplicated Firewall）**
```bash
# 安装
sudo apt install ufw

# 默认策略
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 允许SSH
sudo ufw allow 22/tcp

# 允许HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 启用防火墙
sudo ufw enable

# 查看状态
sudo ufw status verbose
```

**使用iptables（高级）**
```bash
# 列出规则
sudo iptables -L -n -v

# 允许SSH
sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# 保存规则
sudo iptables-save > /etc/iptables/rules.v4
```

### 4. 系统更新

**定期更新系统**
```bash
# Debian/Ubuntu
sudo apt update && sudo apt upgrade -y
sudo apt autoremove

# 自动安全更新
sudo apt install unattended-upgrades
sudo dpkg-reconfigure -plow unattended-upgrades
```

**在更新前备份**
```bash
# 备份重要配置
sudo tar -czf /backup/etc-backup-$(date +%Y%m%d).tar.gz /etc

# 备份数据
rsync -avz /home /backup/
```

### 5. 文件权限

**最小权限原则**
```bash
# 私密文件
chmod 600 ~/.ssh/id_rsa
chmod 600 ~/.ssh/config

# 配置文件
chmod 644 /etc/nginx/nginx.conf

# 可执行脚本
chmod 755 /usr/local/bin/script.sh

# 敏感目录
chmod 700 ~/private/
```

**定期检查权限**
```bash
# 查找777权限（危险）
find / -type f -perm 0777 2>/dev/null

# 查找SUID文件
find / -perm -4000 -type f 2>/dev/null

# 查找无主文件
find / -nouser -o -nogroup 2>/dev/null
```

---

## 系统管理最佳实践

### 1. 日志管理

**启用日志记录**
```bash
# 查看systemd日志
journalctl -xe

# 特定服务日志
journalctl -u nginx -f

# 设置日志保留
sudo vim /etc/systemd/journald.conf
# SystemMaxUse=500M
# MaxRetentionSec=30d
```

**定期清理日志**
```bash
# 手动清理
sudo journalctl --vacuum-time=7d
sudo journalctl --vacuum-size=100M

# 自动清理（cron）
0 2 * * 0 /usr/bin/journalctl --vacuum-time=30d
```

**监控重要日志**
```bash
# 监控失败登录
sudo tail -f /var/log/auth.log | grep "Failed"

# 监控系统错误
sudo journalctl -p err -f
```

### 2. 备份策略

**3-2-1备份原则**
- 3份副本
- 2种不同介质
- 1份异地备份

**自动备份脚本**
```bash
#!/bin/bash
# /usr/local/bin/backup.sh

BACKUP_DIR="/backup"
DATE=$(date +%Y%m%d)
SOURCES="/home /etc /var/www"

# 创建备份
tar -czf "${BACKUP_DIR}/backup-${DATE}.tar.gz" ${SOURCES}

# 保留30天
find "${BACKUP_DIR}" -name "backup-*.tar.gz" -mtime +30 -delete

# 远程备份
rsync -avz "${BACKUP_DIR}/" user@backup-server:/backup/
```

**设置定时备份**
```bash
# 编辑crontab
sudo crontab -e

# 每天凌晨2点备份
0 2 * * * /usr/local/bin/backup.sh
```

### 3. 监控和告警

**安装监控工具**
```bash
# 安装htop
sudo apt install htop

# 安装glances
sudo apt install glances

# 安装nmon
sudo apt install nmon
```

**设置资源告警**
```bash
#!/bin/bash
# monitor.sh

CPU_THRESHOLD=80
DISK_THRESHOLD=90

CPU_USAGE=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
DISK_USAGE=$(df -h / | tail -1 | awk '{print $5}' | sed 's/%//')

if (( $(echo "$CPU_USAGE > $CPU_THRESHOLD" | bc -l) )); then
    echo "CPU使用率过高: ${CPU_USAGE}%" | mail -s "CPU告警" admin@example.com
fi

if [ $DISK_USAGE -gt $DISK_THRESHOLD ]; then
    echo "磁盘使用率过高: ${DISK_USAGE}%" | mail -s "磁盘告警" admin@example.com
fi
```

---

## 开发最佳实践

### 1. 环境管理

**使用版本控制**
```bash
# 初始化git仓库
git init

# 配置.gitignore
cat > .gitignore << EOF
*.log
*.swp
.env
node_modules/
__pycache__/
EOF

# 提交代码
git add .
git commit -m "Initial commit"
```

**使用虚拟环境**
```bash
# Python
python3 -m venv venv
source venv/bin/activate

# Node.js
npm install  # 使用package.json

# 隔离系统环境
```

### 2. 配置管理

**使用环境变量**
```bash
# .env文件
DATABASE_URL=postgresql://localhost/mydb
API_KEY=secret_key

# 在脚本中加载
source .env
echo $DATABASE_URL
```

**配置文件版本控制**
```bash
# 使用模板
cp config.example.json config.json

# .gitignore中排除敏感配置
echo "config.json" >> .gitignore
# 但保留模板
git add config.example.json
```

### 3. 脚本编写

**使用set增强脚本健壮性**
```bash
#!/bin/bash
set -euo pipefail
# -e: 遇到错误立即退出
# -u: 使用未定义变量时报错
# -o pipefail: 管道中任何命令失败都会导致整个管道失败

# 脚本内容...
```

**添加日志和错误处理**
```bash
#!/bin/bash

LOG_FILE="/var/log/myscript.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

error_exit() {
    log "ERROR: $1"
    exit 1
}

log "脚本开始"
command || error_exit "命令执行失败"
log "脚本结束"
```

**参数验证**
```bash
#!/bin/bash

if [ $# -lt 1 ]; then
    echo "用法: $0 <参数>"
    exit 1
fi

ARG1="$1"
```

---

## 性能优化最佳实践

### 1. 磁盘优化

**使用适当的文件系统**
- **ext4** - 通用，稳定
- **XFS** - 大文件性能好
- **Btrfs** - 快照、压缩

**定期清理**
```bash
# 清理包缓存
sudo apt clean

# 清理临时文件
sudo rm -rf /tmp/*

# 清理旧日志
sudo journalctl --vacuum-time=7d
```

**使用tmpfs加速临时文件**
```bash
# /etc/fstab
tmpfs /tmp tmpfs defaults,noatime,mode=1777 0 0
```

### 2. 内存优化

**调整swappiness**
```bash
# 查看当前值
cat /proc/sys/vm/swappiness

# 降低swap使用（推荐10-20）
echo "vm.swappiness=10" | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

**清理缓存**
```bash
# 仅在必要时清理
sync; echo 3 > /proc/sys/vm/drop_caches
```

### 3. 网络优化

**优化TCP参数**
```bash
# /etc/sysctl.conf
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216
net.ipv4.tcp_rmem = 4096 87380 16777216
net.ipv4.tcp_wmem = 4096 65536 16777216
net.ipv4.tcp_fin_timeout = 30
net.ipv4.tcp_keepalive_time = 300

# 应用配置
sudo sysctl -p
```

---

## 命令行技巧

### 1. 使用别名提高效率

```bash
# ~/.bashrc
alias ll='ls -lah'
alias la='ls -A'
alias l='ls -CF'
alias ..='cd ..'
alias ...='cd ../..'
alias grep='grep --color=auto'
alias update='sudo apt update && sudo apt upgrade'
alias ports='netstat -tulanp'
```

### 2. 使用历史命令

```bash
# 启用历史记录时间戳
echo 'export HISTTIMEFORMAT="%Y-%m-%d %H:%M:%S "' >> ~/.bashrc

# 增加历史记录大小
echo 'export HISTSIZE=10000' >> ~/.bashrc
echo 'export HISTFILESIZE=10000' >> ~/.bashrc

# 避免重复命令
echo 'export HISTCONTROL=ignoredups:erasedups' >> ~/.bashrc
```

### 3. 使用快捷键

```bash
Ctrl+R    # 搜索历史命令
Ctrl+A    # 跳到行首
Ctrl+E    # 跳到行尾
Ctrl+U    # 删除到行首
Ctrl+K    # 删除到行尾
Alt+.     # 插入上一命令的最后参数
```

---

## 文档和注释

### 1. 脚本文档

```bash
#!/bin/bash
################################################################################
# 脚本名称：backup.sh
# 作者：Zhang San
# 版本：1.0.0
# 创建日期：2026-01-07
# 描述：系统备份脚本
# 用法：./backup.sh [source] [destination]
################################################################################

# 配置变量
BACKUP_DIR="/backup"
DATE=$(date +%Y%m%d)

# 函数定义
backup_files() {
    # 备份文件到指定位置
    # 参数1：源目录
    # 参数2：目标目录
    local source="$1"
    local dest="$2"

    tar -czf "${dest}/backup-${DATE}.tar.gz" "$source"
}

# 主程序
main() {
    echo "开始备份..."
    backup_files "/home" "$BACKUP_DIR"
    echo "备份完成"
}

main "$@"
```

### 2. README文档

每个项目都应该有README.md文件，包含：
- 项目描述
- 安装步骤
- 使用方法
- 配置说明
- 故障排查
- 贡献指南

---

## 持续学习

### 1. 阅读文档

```bash
man command     # 手册页
info command    # info文档
command --help  # 快速帮助
```

### 2. 实践项目

- 搭建个人服务器
- 自动化日常任务
- 参与开源项目
- 搭建实验环境

### 3. 社区资源

- Stack Overflow
- Linux论坛
- GitHub
- Reddit r/linux
- Arch Wiki

---

## 核心原则

1. **KISS** - Keep It Simple, Stupid（保持简单）
2. **DRY** - Don't Repeat Yourself（不要重复）
3. **最小权限** - 只给必要的权限
4. **自动化** - 能自动化的不手动
5. **文档化** - 记录所有重要操作
6. **测试** - 生产环境前先测试
7. **备份** - 定期备份重要数据
8. **监控** - 持续监控系统状态
9. **安全第一** - 始终考虑安全性
10. **持续学习** - Linux是不断演进的

---

**记住：最佳实践不是教条，而是经验总结。根据实际情况灵活应用！**
